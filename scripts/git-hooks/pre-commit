#!/bin/bash
# Pre-commit hook

echo "Running pre-commit checks..."

# Get changed Terraform files
TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tf|hcl)$' || true)

if [ -z "$TF_FILES" ]; then
    echo "No Terraform files changed"
    exit 0
fi

# Terraform format check
echo "Checking Terraform format..."
if ! terraform fmt -check -recursive .; then
    echo "ERROR: Terraform files not formatted"
    echo "Run: terraform fmt -recursive ."
    exit 1
fi

# Terragrunt format check
echo "Checking Terragrunt format..."
if ! terragrunt hclfmt --terragrunt-check 2>/dev/null; then
    echo "WARNING: Terragrunt format check skipped"
fi

# Check for sensitive data
echo "Checking for sensitive data..."
if echo "$TF_FILES" | xargs grep -iE "aws_access_key_id|aws_secret_access_key|password\s*=" 2>/dev/null; then
    echo "ERROR: Potential sensitive data found"
    exit 1
fi

echo "Pre-commit checks passed!"
exit 0
